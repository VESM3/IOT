# Tímaverkefni 4

- Námsmat 17% af heildareinkunn
- Einstaklingsverkefni
- NiceGUI
<!--Hugsanlegt Windows vandamál: https://aiomqtt.bo3hm.com/#note-for-windows-users -->
---

### 1. NiceGUI (**20%**)

[NiceGUI](https://nicegui.io) er Python safn (e. library) sem gerir tiltölulega einfalt er að búa til gagnvirkar vefsíður.

1. Farðu í gegnum [þennan](https://www.pythonguis.com/tutorials/getting-started-nicegui/) kennsluvef og settu upp dæmin sem eru í honum.
    - Windows: Ef þú færð villu í PowerShell þegar þú keyrir `activate` skoðaðu þá [þetta](https://dev.to/shriekdj/python-venv-or-virtualenv-wont-activate-on-windows-3e2).
1. Búðu til skemmtilega vefsíðu þar sem þú sýnir kunnáttu þína í NiceGUI.
    - Notaðu að minnsta kosti 5 hluti (e. control element).
    - Hafðu að minnsta kosti einn gagnahlut (e. data element).
    - Sýndu að þú kunnir að meðhöndla atburði (e. event) og aðgerðir (e. action).
    - Settu síðuna vel upp setta með þeim tólum sem NiceGUI býður upp á til þess.

> [!IMPORTANT]
> Þegar síðan þín er tilbúin kallar þú til kennara og sýnir honum og útskýrir virknina. Getir þú ekki útskýrt virkni síðunnar verður gefið 0 (núll) fyrir þennan lið.

### 2. Sýna gögn í NiceGUI frá ESP (40%)

#### DHT11

[DHT11](https://components101.com/sensors/dht11-temperature-sensor) er hita- (0°C til 50°C) og rakamælir (20% til 90%). Tengdu DHT11 við ESP32 samkvmæt þessari [mynd](https://github.com/VESM3/IOT/blob/main/Myndir/dht11_tenging.png). Notaðu svo þennan kóða til að sjá hann virka:
```python
from machine import Pin
from dht import DHT11
from time import sleep_ms

maelir = DHT11(Pin(14))

while True:
    # kallar eftir mælingu
    maelir.measure()
    # sækir hitastigið
    hiti = maelir.temperature()
    # sækir rakastigið
    raki = maelir.humidity()
    print(f"{hiti=}, {raki=}")
    sleep_ms(1000)
```

#### Async MQTT í hefðbundu Python (þ.e.fartölvan) (**40%**)

[`aiomqtt`](https://github.com/empicano/aiomqtt) er async MQTT safn fyrir hefðbundið python. Sett inn á hefðbundinn hátt:
```bash
pip install aiomqtt
```

Notkunin fyrir subscribe (virkar á móti sendinum í sýnidæminu í [verkefni 3.2](https://github.com/VESM3/IOT/blob/main/Verkefni/V3.md#2-mqtt-einstefnusamskipti-30)):
```python
import asyncio
from aiomqtt import Client
from random import randint
from nicegui import ui, app

# Breyta sem heldur utan um gögnin frá MQTT
gognin = None

MQTT_BROKER = "test.mosquitto.org"
MQTT_TOPIC = "XXXXkynning"

async def mottaka():
    global gognin
    async with Client(MQTT_BROKER) as client:
        while True:
            await client.subscribe(MQTT_TOPIC)
            async for message in client.messages:
                gognin = message.payload.decode()

# vefsíðan þarf að vera í falli með decarator-num ui.page
@ui.page('/')
def root():
    gagna_label = ui.label("Engin gögn móttekin enn")
    def uppfaera_gogn():
        if gognin:
            gagna_label.set_text(f'{gognin}')
    ui.timer(1.0, uppfaera_gogn) # uppfærist á einnar sekúndu fresti

# NiceGUI ræsir móttökufallið async
app.on_startup(mottaka)

# ræsa vefsíðu
ui.run(root)
```

#### Verkefnið:
- Sendu (e. publish) hita- og rakastigin frá DHT11 sem json til MQTT þjóns (e. broker).
- Taktu á móti hita- og rakastigunum frá MQTT (subscribe) og birtu þau á NiceGUI vefsíðu með snyrtilegu útliti.
    1. Nýjustu gildin sem tölur með label-um.
    1. Síðustu 10 gildin í línuriti.

### 3. Stjórna ESP frá NiceGUI (**40%**)

Dæmi um MQTT sendingar í NiceGUI (virkar á móti móttakaranum í sýnidæminu í [verkefni 3.2](https://github.com/VESM3/IOT/blob/main/Verkefni/V3.md#2-mqtt-einstefnusamskipti-30)):
```python
import asyncio
from nicegui import ui, app
from aiomqtt import Client

MQTT_BROKER = "test.mosquitto.org"
MQTT_TOPIC = "XXXXkynning"

teljari = 0

async def senda():
    global teljari
    async with Client(MQTT_BROKER) as client:
        skilabod = f"Halló {teljari}".encode() 
        await client.publish(MQTT_TOPIC, payload=skilabod)
        teljari += 1

@ui.page('/')
def root():
    ui.button("Senda", on_click=lambda: asyncio.create_task(senda()))
    
app.on_startup(senda)

ui.run()
```

#### Verkefnið:

Gerðu NiceGUI vefsíðu þar sem má stjórna báðum móturunum á fígurinni.
- Sendu (e. publish) gráðurnar fyrir mótorana sem json til MQTT þjóns (e. broker).
- Á vefsíðunni á að vera hægt að stjórna móturunum með tveimur mismunandi aðferðum. Alltaf þarf að vera hægt að sjá á vefsíðunni stöðuna á móturunum (hvað var síðast sent á þá).
    1. Slá inn gildin í tvo aðskylda textareiti og senda með því að ýta á takka.
    2. Nota [stýripinna](https://nicegui.io/documentation/section_controls#joystick) (e. joystick) stýringuna í NiceGUI

## Námsmat og skil

- Skilaðu öllum kóða á Innu
  - Passaðu að þú getir útskýrt kóðann sem þú skilar fyrir kennara.
- Yfirferð á sér stað í tíma. Einkunn fyrir hvern lið: 
    - 10 lausn er vel útfærð.
    - 7.5 lausn er smávægilega ábótavant (vantar smá upp á).
    - 5 lausn er ábótavant, helmingur er vel útfærður.
    - 2.5 lausn er stórlega ábótavant, en tíma- og kóðavinna lögð í lausn.
    - 0 lausn vantar eða óunnin.
