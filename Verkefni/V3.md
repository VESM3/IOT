# Tímaverkefni 3 

- Námsmat 17% af heildareinkunn
- Einstaklingsverkefni
- MQTT, Wifi, NTP

---

⚠️Uppfærðu Micropython á báðum ESP-unum í nýjustu útgáfu áður en þú byrjar á verkefninu ⚠️

## 1. Að fá rauntíma frá NTP (Network Time Protocol) vefþjóni með ESP32  (**30%**)
1. Skoðaðu [WLAN](https://docs.micropython.org/en/latest/esp32/quickref.html#wlan). Tengdu ESP-inn við þráðlausa internetið með `do_connect()` fallinu. Í áfanganum notum við okkar eigið þráðlaust net í kennslustofunni með þessum upplýsingum:
     ```python
     SSID = "TskoliVESM"
     LYKILORD = "Fallegurhestur"
     ```
1. Kynntu þér svo NTP og hvernig það er notað í Micropython með því að skoða þessa [grein](https://bhave.sh/micropython-ntp/).
1. Náðu í réttan tíma með NTP (Keyrðu `main.py` í ESP32 og ýttu á reset). 
1. Skoðaðu hvernig unnið er með tíma í micropython með því að skoða [þetta](https://docs.micropython.org/en/latest/library/time.html). Micropython inniheldur ekki `datatime` klasasafnið.
     ```python
     // aðferð til að varpa tíma (tuple) yfir í breytur.
      _, _, _, klst, minutur, sekundur, _, _ = localtime()
     print(f"{klst:02}:{minutur:02}:{sekundur:02}")
     ```
1. Láttu augun blikka á ákveðnum tíma með NTP.


<!-- 1. Láttu svo þestta hefjast á 10 sekúndu fresti. -->
   
<br>

> [!Note]
> - Ef þú færð `OSError: [Errno 116] ETIMEDOUT` eða `OSError: [Errno 118] EHOSTUNREACH` hinkraðu þá í smá stund og prófaðu aftur.
> - Notaðu hotspot í síma ef skólanet virkar ekki.
> - **Ekki** nota pinna; GPIO0, GPIO3, GPIO19, GPIO20, GPIO45, GPIO46. 


<!--
Skoðaðu [Timers](https://docs.micropython.org/en/latest/esp32/quickref.html#timers) til að láta tímann uppfærast á ákveðnum fresti.
Bættu við smá `sleep` til að gefa ESP32 smá tíma til að tengjast wifi.
-->

---

## 2. MQTT, einstefnusamskipti (**30%**)

Kynntu þér allt um [MQTT](https://mqtt.org) og [mqtt_as](https://github.com/peterhinch/micropython-mqtt) safnið.

Settu mqtt_as safnið inn á ESP_ana þína með því að keyra eftirfarandi kóða á þeim:

```python
def do_connect():
    import network
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        print('connecting to network...')
        wlan.connect("TskoliVESM", "Fallegurhestur")
        while not wlan.isconnected():
            pass
    print('network config:', wlan.ifconfig())
    
do_connect()

import mip
mip.install("github:peterhinch/micropython-mqtt")
```


Sýnidæmi (sendir Hallo ásamt teljara):

<details>
<summary>Sendir</summary>

```python
from mqtt_as import MQTTClient, config
import asyncio

# WIFI stillingar
config["ssid"] = "TskoliVESM"
config["wifi_pw"] = "Fallegurhestur"

# MQTT þjónninn
config["server"] = "test.mosquitto.org" # eða broker.emqx.io (þarf að vera það sama á sendir og móttakara)

# TOPICS
TOPIC = "XXXXkynning" # Settu fyrstu fjóra stafinu úr kennitölunni þinni stað í X-anna

async def sendir(client):
    teljari = 0
    while True:
        # Skilaboðin sem á að senda, þarf encode ef senda á íslenska stafi
        skilabod = f"Halló {teljari}".encode() 
        print(f"sendi: {skilabod}" )
        # Skilaboðin send
        await client.publish(TOPIC, skilabod)
        # Sendi á tveggja sekúnda fresti
        await asyncio.sleep_ms(2000)
        teljari += 1

async def main(client):
    # tengjast við þráðlausa netið
    await client.connect()
    # búa til task
    asyncio.create_task(sendir(client))
    while True:
        # Hér kæmi kóði sem á ekki að keyra async
        await asyncio.sleep_ms(0)

# Sýnir ýmsar upplýsingar eins og t.d. varðandi nettenginguna og minnisnotkun  
MQTTClient.DEBUG = True

# Búa til tilvik af MQTTClient og senda inn stillingarnar
client = MQTTClient(config)

try:
    # Ræsa async main fallið og senda þangað tilvik af client-num
    asyncio.run(main(client))
finally:
    client.close()
```
</details>

<details>
<summary>Móttakari</summary>

```python
from mqtt_as import MQTTClient, config
import asyncio

# WIFI stillingar
config["ssid"] = "TskoliVESM"
config["wifi_pw"] = "Fallegurhestur"

# MQTT þjónninn
config["server"] = "test.mosquitto.org" # eða broker.emqx.io (þarf að vera það sama á sendir og móttakara)
config["queue_len"] = 1

# TOPICS
TOPIC = "XXXXkynning" # Settu fyrstu fjóra stafinu úr kennitölunni þinni stað í X-anna
#TOPIC_2 = "YYYYkynning"

# Fallið meðhöndlar skilaboð sem berast
async def mottakari(client):
    # skilaboðin berast í biðröð (e. queue) sem við sækjum þau svo úr
    async for topic, skilabod, _ in client.queue:
        hallo, tala = skilabod.decode().split()
        # ef nota á töluna þarf að setja hana í int fallið
        tala = int(tala)
        print(f"TOPIC: {topic.decode()}, texti: {hallo}, tala: {tala}")

# Fallið sér um að gerast ákrifandi að topic-um og viðhalda áskriftinni ef tenging tapast
async def askrift(client):
    while True:
        await client.up.wait()
        client.up.clear()
        # Topik-ið (eitt eða fleiri) sem á að gerast áskrifandi að
        await client.subscribe(TOPIC, 1) 
        # await client.subscribe(TOPIC_2, 1) 

async def main(client):
    # tengjast við þráðlausa netið
    await client.connect()
    # búa til task
    asyncio.create_task(askrift(client))
    asyncio.create_task(mottakari(client))
    while True:
        # Hér kæmi kóði sem á ekki að keyra async, t.d. lesa frá stilliviðnámi
        await asyncio.sleep_ms(0)

# Sýnir ýmsar upplýsingar eins og t.d. varðandi nettenginguna og minnisnotkun  
MQTTClient.DEBUG = True

# Búa til tilvik af MQTTClient og senda inn stillingarnar
client = MQTTClient(config)

try:
    # Ræsa async main fallið og senda þangað tilvik af client-num
    asyncio.run(main(client))
finally:
    client.close()
```
</details>

#### Að hafa tvo Thonny glugga opna samtímis
Í Thonny skaltu fara í Tools->Options->General og taka hakið úr *Allow only single Thonny instance*, **lokaðu svo Thonny**. Þá getur þú opnað tvo Thonny glugga. Á Mac þarf að opna glugga nr. 2 með því að fara í terminal og skrifa eftirfarandi: `open -n -a Thonny.app`

### Verkefnið
Þegar þú hefur fengið MQTT til að virka áttu að gera eftirfarandi:

Tengdu [stilliviðnám](https://cdn-learn.adafruit.com/guides/images/000/002/179/medium800/562-00.jpg) við ESP-inn sem er sendir og NeoPixel hring við ESP-inn sem er móttakari. Tengdu S (IN megin) við pinna 45 á ESP32-S3 (stakur), V í 3.3V línuna og G í GND línuna á NeoPixel hringnum. 

Notaðu stilliviðnámið til að stjórna hvaða ljós lýsa á NeoPixel hringnum. Ef stilliviðnáminu er snúið alveg í aðra áttina er bara kveikt á einni peru en svo fjölgar perunum sem lýsa eftir því sem viðnáminu er snúið í hina áttina og endar með því að allar perurnar lýsa.


<details>
<summary>NeoPixel hringur - kóðasýnidæmi</summary>
<br>

```python

from machine import Pin
from neopixel import NeoPixel
from time import sleep_ms

neo = NeoPixel(Pin(45), 8)   #  8 Leds (0 - 7)

# slökktu á öllum leds
neo.fill([0, 0, 0])

# Allar NeoPixel perurnar lýsa rauðu ljósi í eina sekúndu með fill aðferð.
neo.fill([255, 0, 0])
neo.write()
sleep_ms(1000)

# fjórða LED er lýst með grænum lit
neo[3] = [0, 255, 0]
neo.write()

```

</details>

> [!Note]
> - Mundu að allt er sent sem strengur þannig að í mótttökunni þarftu að breyta yfir í `int`.
> - [ADC2](https://github.com/VESM3/IOT/wiki/ESP32) pinnar (11 - 18) fyrir analog virka ekki þegar við erum að nota wifi. Þú verður því að nota pinna úr **ADC1** sem eru pinnar 1 til og með 10.
> [Lesa hliðrænt (e. analog) með ESP32](https://github.com/VESM1VS/AFANGI/blob/main/Kennsluefni/analog.md#lesi%C3%B0-fr%C3%A1-pinna)

---

## 3. MQTT, tvístefnusamskipti (**40%**)

### 3.1 augun
1. Tengdu takka við ESP32 (stakur) og kveiktu á báðum augum (led) á fígúrunni með honum. Láttu led breyta um lit á 1 sek. fresti á fígúru.
1. Sendu til baka litastöðuna í JSON frá fígúru á 1 sek. fresti.
1. Láttu LED<sub>1</sub> á ESP32 (stakur) vera með sömu litastöðu og sama takt og augun.

### 3.2 háls
1. Tengdu breytiviðnámi við ESP32 (stakur) og notaðu hann til að stýra hraðanum á Servo (háls) á fígúrunni.
1. Sendu til baka hraðastöðuna í JSON frá fígúru á 1 sek. fresti (nota sama JSON og litastöðu).
1. Birtu hraðastöðu með print á ESP32 (stakur).

<sub>1</sub> LED er innbyggða NeoPixel peran á ESP32 (pinni 48).

Sýnikóði. ESP-A publish-ar _Hallo X_ (þar sem X er stighækkandi tala) á topic-ið XXXX_A_til_B sem ESP-B er áskrifandi að. ESP-B publish-ar _Bless X_ á topic-ið XXXX_B_til_A sem ESP-A er áskrifandi að.

<details>
<summary>ESP-A</summary>

```python
from mqtt_as import MQTTClient, config
import asyncio

# WIFI stillingar
config["ssid"] = "TskoliVESM"
config["wifi_pw"] = "Fallegurhestur"

# MQTT þjónninn
config["server"] = "test.mosquitto.org" # eða broker.emqx.io (þarf að vera það sama á sendir og móttakara)
config["queue_len"] = 1

# TOPICS
TOPIC_SENDING = "XXXX_A_til_B" # Settu fyrstu fjóra stafinu úr kennitölunni þinni stað í X-anna
TOPIC_MOTTAKA = "XXXX_B_til_A"

# Fallið meðhöndlar skilaboð sem berast
async def mottakari(client):
    # skilaboðin berast í biðröð (e. queue) sem við sækjum þau úr
    async for topic, skilabod, _ in client.queue:
        print("móttek frá B: ", topic.decode(), skilabod.decode())

async def sendir(client):
    teljari = 0
    while True:
        # Skilaboðin sem á að senda, þarf encode ef senda á íslenska stafi
        skilabod = f"Halló {teljari}".encode() 
        print(f"sendi til B: {skilabod}" )
        # Skilaboðin send
        await client.publish(TOPIC_SENDING, skilabod)
        # Sendi á tveggja sekúnda fresti
        await asyncio.sleep_ms(2000)
        teljari += 1

# Fallið sér um að gerast ákrifandi að topic-um og viðhalda áskriftinni ef tenging tapast
async def askrift(client):
    while True:
        await client.up.wait()
        client.up.clear()
        # Topik-ið (eitt eða fleiri) sem á að gerast áskrifandi að
        await client.subscribe(TOPIC_MOTTAKA, 1) 
        # await client.subscribe(TOPIC_2, 1) 

async def main(client):
    # tengjast við þráðlausa netið
    await client.connect()
    # búa til task
    asyncio.create_task(askrift(client))
    asyncio.create_task(mottakari(client))
    asyncio.create_task(sendir(client))

    while True:
        # Ekkert að gera hér
        await asyncio.sleep_ms(0)

# Sýnir ýmsar upplýsingar eins og t.d. varðandi nettenginguna og minnisnotkun  
MQTTClient.DEBUG = True

# Búa til tilvik af MQTTClient og senda inn stillingarnar
client = MQTTClient(config)

try:
    # Ræsa async main fallið og senda þangað tilvik af client-num
    asyncio.run(main(client))
finally:
    client.close()
```
</details>

<details>
<summary>ESP-B</summary>
<br>

```python
from mqtt_as import MQTTClient, config
import asyncio

# WIFI stillingar
config["ssid"] = "TskoliVESM"
config["wifi_pw"] = "Fallegurhestur"

# MQTT þjónninn
config["server"] = "test.mosquitto.org" # eða broker.emqx.io (þarf að vera það sama á sendir og móttakara)
config["queue_len"] = 1

# TOPICS
TOPIC_SENDING = "XXXX_B_til_A" # Settu fyrstu fjóra stafinu úr kennitölunni þinni stað í X-anna
TOPIC_MOTTAKA = "XXXX_A_til_B"

# Fallið meðhöndlar skilaboð sem berast
async def mottakari(client):
    # skilaboðin berast í biðröð (e. queue) sem við sækjum þau úr
    async for topic, skilabod, _ in client.queue:
        print("móttek frá A: ", topic.decode(), skilabod.decode())

async def sendir(client):
    teljari = 0
    while True:
        # Skilaboðin sem á að senda, þarf encode ef senda á íslenska stafi
        skilabod = f"Bless {teljari}".encode() 
        print(f"sendi til A: {skilabod}" )
        # Skilaboðin send
        await client.publish(TOPIC_SENDING, skilabod)
        # Sendi á tveggja sekúnda fresti
        await asyncio.sleep_ms(2000)
        teljari += 1

# Fallið sér um að gerast ákrifandi að topic-um og viðhalda áskriftinni ef tenging tapast
async def askrift(client):
    while True:
        await client.up.wait()
        client.up.clear()
        # Topik-ið (eitt eða fleiri) sem á að gerast áskrifandi að
        await client.subscribe(TOPIC_MOTTAKA, 1) 
        # await client.subscribe(TOPIC_2, 1) 

async def main(client):
    # tengjast við þráðlausa netið
    await client.connect()
    # búa til task
    asyncio.create_task(askrift(client))
    asyncio.create_task(mottakari(client))
    asyncio.create_task(sendir(client))

    while True:
        # Ekkert að gera hér
        await asyncio.sleep_ms(0)

# Sýnir ýmsar upplýsingar eins og t.d. varðandi nettenginguna og minnisnotkun  
MQTTClient.DEBUG = True

# Búa til tilvik af MQTTClient og senda inn stillingarnar
client = MQTTClient(config)

try:
    # Ræsa async main fallið og senda þangað tilvik af client-num
    asyncio.run(main(client))
finally:
    client.close()
```

</details>

---

<!--
## 4. Sena/samskipti með tvo ESP32, asynco og mqtt (**25%**) 
**TODO liður 3 kannski bara nóg?**

Búðu til eftirfarandi senu með tveimur ESP32:

1. Ýtt er á takka á ESP32 (stakur), fyrirmæli eru send um að opna og loka kjálkanum tvisvar á hauskúpu (hinn ESP32). 
1. Fyrirmæli eru þá send tilbaka frá hauskúpu til ESP32 (stakur) um að kveikja á grænu LED<sub>1</sub>. 
1. Þegar LED<sub>1</sub> hefur lýst grænu í eina sekúndu á ESP32 (stakur) þá slökkva á LED<sub>1</sub> og fyrirmæli svo send á hauskúpu um að láta haus snúa til hliðar rólega (90 gráður) til vinstri og svo til hægri 90 gráður, augun eiga að blikka á meðan þessu stendur.

<sub>1</sub> LED er innbyggða NeoPixel peran á ESP32 (pinni 48).

![flæðirit](https://github.com/VESM3/IOT/blob/main/Myndir/V25_v3_4.drawio.svg)

-->

## Námsmat og skil

- Skilaðu öllum kóða á Innu
  - Passaðu að þú getir útskýrt kóðann sem þú skilar fyrir kennara.
- Yfirferð á sér stað í tíma. Einkunn fyrir hvern lið: 
    - 10 lausn er vel útfærð.
    - 7.5 lausn er smávægilega ábótavant (vantar smá upp á).
    - 5 lausn er ábótavant, helmingur er vel útfærður.
    - 2.5 lausn er stórlega ábótavant, en tíma- og kóðavinna lögð í lausn.
    - 0 lausn vantar eða óunnin.




<!--

> `volume` fallið tekur inn heiltölu á bilinu 0 til og með 30

> [!Tip]
>  - Hafðu tvö MQTT topic, annað fyrir hita og raka en hitt fyrir litastyrk og lit, t.d. `XXXX/hiti_raki` og `XXXX/litur_styrkur`.
>  - Í stað `umqtt.simple` skaltu nota `umqtt.robust` því það er með innbyggða villumeðhöndlun.

Bjargir:
- [DHT11 og micropython](https://docs.micropython.org/en/latest/esp32/quickref.html#dht-driver)

Servo-arnir eiga allir að hreyfast lítillega (ca. 25°).

- [umqtt.simple og robust](https://github.com/micropython/micropython-lib/tree/master/micropython)
- [mqtt söfn](https://awesome-micropython.com/#mqtt)
  
Messages can be sent with a quality of service (QoS),
- At most once - the message is sent only once (fire and forget).
- At least once - until acknowledgement is received (multiple times).
- Exactly once - to ensure only one copy of the message is received (assured delivery).

MQTT supports a keep alive function that checks if the connection is still alive during long gaps between messages.

-->
